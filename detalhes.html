<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Equipamento - Goiana</title>

    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GMG Goiana">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #007bff;
            --bg-color: #f4f7f9;
            --text-dark: #2d3436;
            --border-color: #dfe6e9;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; color: var(--text-dark); }
        
        .container-detalhes { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        
        .header-detalhes { background: var(--primary-blue); color: white; padding: 30px; text-align: center; }
        .header-detalhes h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; }
        
        .content { padding: 30px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .info-box { border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .info-box label { display: block; font-size: 0.75rem; font-weight: 700; color: #636e72; text-transform: uppercase; margin-bottom: 5px; }
        .info-box span { font-size: 1.1rem; color: #2d3436; font-weight: 500; }
        
        .full-width { grid-column: span 2; }
        
        .obs-box { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary-blue); margin-top: 20px; }
        
        .footer-btns { display: flex; gap: 10px; margin-top: 30px; }
        .btn { flex: 1; padding: 15px; border-radius: 8px; text-align: center; text-decoration: none; font-weight: 600; cursor: pointer; border: none; color: white }
        .btn-voltar { background: #eee; color: #555; }
        .btn-print { background: var(--primary-blue); color: white; }

        /* Estilo da Linha do Tempo de Movimenta√ß√£o */
        .timeline {
            margin-top: 15px;
            border-left: 3px solid var(--primary-blue);
            padding-left: 20px;
            margin-left: 10px;
        }

        .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }

        /* O pontinho azul na linha */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 5px;
            width: 12px;
            height: 12px;
            background: var(--primary-blue);
            border-radius: 50%;
            border: 2px solid white;
        }

        .timeline-date {
            font-size: 0.75rem;
            font-weight: 700;
            color: #636e72;
            margin-bottom: 3px;
            display: block;
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid #eee;
        }

        .mov-label {
            font-weight: 600;
            color: var(--primary-blue);
        }

        /* --- ESTILO DOS NOVOS BAL√ïES DE EDI√á√ÉO --- */
        .input-editavel {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Igual ao arredondamento dos cards */
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #fcfcfc;
            color: var(--text-dark);
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Sombra interna suave */
        }

        .input-editavel:focus {
            outline: none;
            border-color: var(--primary-blue);
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); /* Brilho azul igual ao index */
        }

        /* Ajuste para quando o campo for o de observa√ß√µes */
        textarea.input-editavel {
            min-height: 100px;
            resize: vertical;
        }

        /* Impede que a borda de baixo da info-box suma na edi√ß√£o */
        .info-box:focus-within {
            border-bottom: 1px solid var(--primary-blue);
        }

        /* Estilos para o Status de Empr√©stimo */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 5px;
        }
        .status-disponivel { background: #d4edda; color: #155724; }
        .status-emprestado { background: #fff3cd; color: #856404; }
        
        /*est√° em desuso [pois est√° dentro do .btn] */
        .btn-emprestar { background: #6c5ce7; color: white; }
        .btn-devolver { background: #00b894; color: white; }

        /* Modal simples para empr√©stimo */
        #modal-emprestimo {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }

        @media (max-width: 600px) { .info-grid { grid-template-columns: 1fr; } }
        @media print { .btn { display: none; } body { padding: 0; } .container-detalhes { box-shadow: none; border: 1px solid #000; } }
    </style>
</head>
<body>

    <div class="container-detalhes">
        <div class="header-detalhes">
            <h1 id="det-tombamento">Carregando...</h1>
            <p>Ficha Completa do Equipamento</p>
        </div>

        <div class="content">
    <div class="info-grid" id="container-campos">
        <div class="info-box">
            <label>Tipo de Equipamento</label>
            <span id="det-tipo">-</span>
        </div>
        <div class="info-box">
            <label>Marca / Fabricante</label>
            <span id="det-marca">-</span>
        </div>
        <div class="info-box">
            <label>Modelo</label>
            <span id="det-modelo">-</span>
        </div>
        <div class="info-box">
            <label>Secretaria / Departamento</label>
            <span id="det-secretaria">-</span>
        </div>
        <div class="info-box full-width">
            <label>Localiza√ß√£o Espec√≠fica</label>
            <span id="det-localizacao">-</span>
        </div>
        <div class="info-box full-width">
            <label>Observa√ß√µes e Hist√≥rico</label>
            <div class="obs-box"><span id="det-obs">Nenhuma observa√ß√£o registrada.</span></div>
        </div>
    </div>

    <div class="info-box full-width" style="border-bottom: 2px solid #f0f0f0; margin-bottom: 10px;">
        <label>Status de Cust√≥dia</label>
            <div id="status-container">
                <span id="det-status" class="status-badge status-disponivel">Dispon√≠vel</span>
                <span id="det-responsavel" style="display:block; font-size: 0.9rem; margin-top:5px; color:#636e72;"></span>
            </div>
        </div>
        

    <div class="footer-btns" id="botoes-emprestimo" style="margin-top: 20px;">
        <button id="btn-acao-emprestimo" class="btn" onclick="abrirModalEmprestimo()">ü§ù Emprestar / Sa√≠da</button>
    </div>

    <div id="modal-emprestimo">
        <h3>Registrar Sa√≠da</h3>
        <label>Nome do Respons√°vel</label>
        <input type="text" id="nome-responsavel" class="input-editavel" placeholder="Quem est√° levando?">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="confirmarEmprestimo()" class="btn" style="background:#27ae60; color:white;">Confirmar</button>
            <button onclick="fecharModal()" class="btn" style="background:#eee; color:#333;">Sair</button>
        </div>
    </div>

    <div class="info-box full-width" style="margin-top: 25px;">
        <label>Hist√≥rico de Movimenta√ß√µes (Rastreabilidade)</label>
        <div id="lista-movimentacao" class="timeline">
            <p style="color: #888; font-size: 0.9rem;">Nenhuma movimenta√ß√£o registrada ainda.</p>
        </div>
    </div>


    <div class="footer-btns" id="botoes-visualizacao" style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="habilitarEdicao()" class="btn" style="background: #f39c12; color: white; flex: 1;">‚úèÔ∏è Editar</button>
        <button onclick="deletarEquipamento()" class="btn" style="background: #e74c3c; color: white; flex: 1;">üóëÔ∏è Excluir</button>
    </div>

    <div class="footer-btns" id="botoes-edicao" style="display: none; gap: 10px; margin-top: 20px;">
        <button onclick="salvarAlteracoes()" class="btn" style="background: #27ae60; color: white; flex: 1;">‚úÖ Salvar</button>
        <button onclick="cancelarEdicao()" class="btn" style="background: #95a5a6; color: white; flex: 1;">Cancelar</button>
    </div>
    
    <div id="aviso-revisao" style="display:none; background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align:center;">
        <p style="margin:0; color: #856404; font-weight:600;">
            ‚ö†Ô∏è Este equipamento precisa de revis√£o de 90 dias.
        </p>
        <button onclick="confirmarTudoCerto()" class="btn" style="background: #27ae60; color:white; padding: 8px 15px; margin-top: 10px; font-size: 0.85rem; width:auto;">
            Confirmar que est√° com o respons√°vel
        </button>
    </div>
    <div class="footer-btns" style="margin-top: 15px;">
        <a href="index.html" class="btn btn-voltar" style="width: 100%; display: block; box-sizing: border-box;">Voltar √† Lista</a>
    </div>


    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB7kGKWnj0EeQyPLhFmYE0Otju-AVgOs7U",
        authDomain: "gerenciamento-maquinas-goiana.firebaseapp.com",
        databaseURL: "https://gerenciamento-maquinas-goiana-default-rtdb.firebaseio.com",
        projectId: "gerenciamento-maquinas-goiana",
        storageBucket: "gerenciamento-maquinas-goiana.firebasestorage.app",
        messagingSenderId: "532766971298",
        appId: "1:532766971298:web:d04d1e40d0d349a7a48efb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const idEquipamento = urlParams.get('id');

    if (idEquipamento) {
        const itemRef = ref(db, `equipamentos/${idEquipamento}`);

        // --- CARREGAR DADOS (Sincroniza√ß√£o em tempo real) ---
        onValue(itemRef, (snapshot) => {
            const item = snapshot.val();
            if (!item) {
                alert("Equipamento n√£o encontrado!");
                window.location.href = 'index.html';
                return;
            }

            // Preenchimento de texto
            document.getElementById('det-tombamento').innerText = "Tombamento: " + (item.tombamento || 'N/A');
            document.getElementById('det-tipo').innerText = item.tipo || "-";
            document.getElementById('det-marca').innerText = item.marca || "-";
            document.getElementById('det-modelo').innerText = item.modelo || "-";
            document.getElementById('det-secretaria').innerText = item.secretaria || "-";
            document.getElementById('det-localizacao').innerText = item.localizacao || "N√£o informada";
            document.getElementById('det-obs').innerText = item.obs || "Sem observa√ß√µes adicionais.";

            // L√≥gica de Status e Aviso de 90 dias
            const elStatus = document.getElementById('det-status');
            const elResp = document.getElementById('det-responsavel');
            const btnEmprestar = document.getElementById('btn-acao-emprestimo');
            const avisoRevisao = document.getElementById('aviso-revisao');

            if (item.status === "emprestado") {
                elStatus.innerText = "EMPRESTADO";
                elStatus.className = "status-badge status-emprestado";
                elResp.innerText = `üë§ Atualmente com: ${item.responsavel_atual}`;
                btnEmprestar.innerText = "‚Ü©Ô∏è Registrar Devolu√ß√£o";
                btnEmprestar.style.background = "#00b894";

                // VERIFICA√á√ÉO DE DATA (90 DIAS)
                if (item.proxima_verificacao) {
                    const hoje = new Date();
                    const dataLimite = new Date(item.proxima_verificacao);
                    
                    if (hoje > dataLimite) {
                        avisoRevisao.style.display = "block";
                    } else {
                        avisoRevisao.style.display = "none";
                    }
                }
            } else {
                elStatus.innerText = "DISPON√çVEL";
                elStatus.className = "status-badge status-disponivel";
                elResp.innerText = "‚úÖ Dispon√≠vel no setor";
                btnEmprestar.innerText = "ü§ù Emprestar / Sa√≠da";
                btnEmprestar.style.background = "#6c5ce7";
                avisoRevisao.style.display = "none"; // Esconde se estiver dispon√≠vel
            }

            // Hist√≥rico
            const containerMov = document.getElementById('lista-movimentacao');
            if (item.historicoMovimentacao && item.historicoMovimentacao.length > 0) {
                containerMov.innerHTML = "";
                [...item.historicoMovimentacao].reverse().forEach(mov => {
                    const divItem = document.createElement('div');
                    divItem.className = 'timeline-item';
                    divItem.innerHTML = `
                        <span class="timeline-date">${mov.data}</span>
                        <div class="timeline-content">
                            <div><span class="mov-label">Origem:</span> ${mov.origem}</div>
                            <div><span class="mov-label">Destino:</span> ${mov.destino}</div>
                        </div>`;
                    containerMov.appendChild(divItem);
                });
            }
        });

        // --- FUN√á√ïES GLOBAIS (A√ß√µes) ---

        window.habilitarEdicao = function() {
            document.getElementById('botoes-visualizacao').style.display = 'none';
            document.getElementById('botoes-edicao').style.display = 'flex';
            const campos = ['det-tipo', 'det-marca', 'det-modelo', 'det-secretaria', 'det-localizacao', 'det-obs'];
            campos.forEach(id => {
                const el = document.getElementById(id);
                const valorAtual = (el.innerText === "-" || el.innerText === "N√£o informada" || el.innerText === "Sem observa√ß√µes adicionais.") ? "" : el.innerText;
                if (id === 'det-obs') {
                    el.innerHTML = `<textarea id="input-${id}" class="input-editavel">${valorAtual}</textarea>`;
                } else {
                    el.innerHTML = `<input type="text" id="input-${id}" value="${valorAtual}" class="input-editavel">`;
                }
            });
        };

        window.salvarAlteracoes = function() {
            const novosDados = {
                tipo: document.getElementById('input-det-tipo').value,
                marca: document.getElementById('input-det-marca').value,
                modelo: document.getElementById('input-det-modelo').value,
                secretaria: document.getElementById('input-det-secretaria').value,
                localizacao: document.getElementById('input-det-localizacao').value,
                obs: document.getElementById('input-det-obs').value
            };
            update(itemRef, novosDados).then(() => {
                alert("Dados atualizados!");
                location.reload();
            });
        };

        window.confirmarEmprestimo = function() {
            const nome = document.getElementById('nome-responsavel').value;
            if (!nome) return alert("Digite o nome!");
            const hoje = new Date();
            const prox = new Date();
            prox.setDate(hoje.getDate() + 90);

            update(itemRef, {
                status: "emprestado",
                responsavel_atual: nome,
                data_emprestimo: hoje.toISOString(),
                proxima_verificacao: prox.toISOString(),
                ultima_movimentacao: hoje.toLocaleDateString('pt-BR')
            }).then(() => {
                alert("Empr√©stimo realizado!");
                location.reload();
            });
        };

        window.registrarDevolucao = function() {
            update(itemRef, {
                status: "disponivel",
                responsavel_atual: "",
                proxima_verificacao: null, // Limpa a verifica√ß√£o ao devolver
                ultima_movimentacao: new Date().toLocaleDateString('pt-BR')
            }).then(() => {
                alert("Devolvido!");
                location.reload();
            });
        };

        window.confirmarTudoCerto = function() {
            const novaData = new Date();
            novaData.setDate(novaData.getDate() + 90);
            update(itemRef, { proxima_verificacao: novaData.toISOString() })
            .then(() => {
                alert("Revis√£o confirmada!");
                location.reload();
            });
        };

        window.deletarEquipamento = function() {
            if (confirm("Excluir permanentemente?")) {
                remove(itemRef).then(() => window.location.href = 'index.html');
            }
        };

    } else {
        window.location.href = 'index.html';
    }

    window.abrirModalEmprestimo = function() {
        const status = document.getElementById('det-status').innerText;
        if (status === "EMPRESTADO") {
            if(confirm("Registrar devolu√ß√£o?")) registrarDevolucao();
        } else {
            document.getElementById('modal-emprestimo').style.display = 'block';
        }
    };

    window.fecharModal = function() {
        document.getElementById('modal-emprestimo').style.display = 'none';
    };

    window.cancelarEdicao = function() { location.reload(); };
</script>
</body>
</html>
